<div class="flex flex-col h-full bg-gray-50 rounded-2xl overflow-hidden border border-gray-200 shadow-inner">
  
  <div class="bg-white px-4 py-2 border-b border-gray-100 flex items-center justify-between text-xs text-gray-500">
    <div class="flex items-center gap-2">
      <div class="w-2 h-2 rounded-full" 
           [ngClass]="isConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500'"></div>
      <span>{{ isConnected ? 'En lÃ­nea' : 'Desconectado' }}</span>
    </div>
    <div *ngIf="userSemaphoreColor" class="flex items-center gap-1">
      <span>Tu estado:</span>
      <app-semaphore-badge [color]="userSemaphoreColor" [warningCount]="userWarningCount" [showText]="true"></app-semaphore-badge>
    </div>
  </div>

  <div #messagesContainer class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
    
    <div *ngIf="isLoading" class="space-y-4 opacity-50">
       <div class="flex gap-2">
         <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
         <div class="h-10 bg-gray-200 rounded-xl w-2/3"></div>
       </div>
       <div class="flex gap-2 flex-row-reverse">
         <div class="h-10 bg-blue-100 rounded-xl w-1/2"></div>
       </div>
    </div>

    <div *ngIf="!isLoading && messages.length === 0" class="h-full flex flex-col items-center justify-center text-gray-400">
      <span class="text-4xl mb-2">ğŸ‘‹</span>
      <p>No hay mensajes aÃºn.</p>
      <p class="text-sm">Â¡SÃ© el primero en saludar!</p>
    </div>

    <ng-container *ngFor="let msg of messages">
      
      <div *ngIf="msg.is_system" class="flex justify-center my-2">
        <span class="bg-gray-100 text-gray-600 text-xs px-3 py-1 rounded-full border border-gray-200">
          ğŸ”” {{ msg.content }}
        </span>
      </div>

      <div *ngIf="!msg.is_system" 
           class="flex gap-3 group" 
           [ngClass]="isMyMessage(msg) ? 'flex-row-reverse' : 'flex-row'">
        
        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white shadow-sm"
             [ngClass]="isMyMessage(msg) ? 'bg-blue-500' : 'bg-gray-400'">
          {{ getAvatarInitial(msg.sender) }}
        </div>

        <div class="flex flex-col max-w-[75%]" 
             [ngClass]="isMyMessage(msg) ? 'items-end' : 'items-start'">
          
          <div class="px-4 py-2 rounded-2xl shadow-sm text-sm relative transition-all"
               [ngClass]="{
                 'bg-blue-600 text-white rounded-tr-none': isMyMessage(msg),
                 'bg-white text-gray-800 border border-gray-100 rounded-tl-none hover:bg-gray-50 cursor-pointer': !isMyMessage(msg)
               }"
               (click)="onMessageClick(msg)">
            
            <p *ngIf="!isMyMessage(msg)" class="text-xs font-bold text-blue-600 mb-1">
              {{ getSenderName(msg.sender) }}
            </p>
            
            <p class="whitespace-pre-wrap leading-relaxed">{{ msg.content }}</p>
            
            <p class="text-[10px] mt-1 text-right opacity-70"
               [ngClass]="isMyMessage(msg) ? 'text-blue-100' : 'text-gray-400'">
              {{ formatTimestamp(msg.created_at) }}
            </p>
          </div>
          
          <span *ngIf="canModerate && !isMyMessage(msg)" class="text-[12px] text-black-400 group-hover:opacity-100 transition-opacity mt-1">
           âš ï¸ Clica el mensaje para advertir al usuario
          </span>
        </div>
      </div>

    </ng-container>
  </div>

  <div *ngIf="isBanned" class="bg-red-50 p-4 border-t border-red-100 flex items-center gap-3 text-red-800">
    <span class="text-2xl">ğŸš«</span>
    <div>
      <p class="font-bold text-sm">Has sido suspendido de este chat.</p>
      <p class="text-xs">No puedes enviar mensajes por el momento.</p>
    </div>
  </div>

  <form *ngIf="!isBanned" [formGroup]="messageForm" (ngSubmit)="sendMessage()" 
        class="bg-white p-3 border-t border-gray-200 flex items-end gap-2">
    
    <div class="flex-1 bg-gray-100 rounded-2xl flex items-center px-4 py-2 focus-within:ring-2 focus-within:ring-blue-400 focus-within:bg-white transition-all">
      <input 
        type="text" 
        formControlName="content"
        class="bg-transparent border-none w-full focus:outline-none text-gray-700 placeholder-gray-400"
        placeholder="Escribe un mensaje..."
        autocomplete="off">
    </div>

    <button 
      type="submit" 
      [disabled]="messageForm.invalid || isSending || !isConnected"
      class="w-10 h-10 rounded-full flex items-center justify-center text-white transition-all disabled:opacity-50 disabled:scale-90"
      [ngClass]="messageForm.valid ? 'bg-blue-600 hover:bg-blue-700 shadow-md' : 'bg-gray-300'">
      
      <span *ngIf="!isSending">â¤</span>
      <span *ngIf="isSending" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
    </button>
  </form>
</div>

<app-moderation-modal
  *ngIf="showModerationModal"
  [isOpen]="showModerationModal"
  [user]="selectedUserToWarn"
  [contextType]="contextType"
  [contextId]="contextId"
  (close)="closeModerationModal()"
  (warningIssued)="onWarningIssued()">
</app-moderation-modal>