<div class="flex flex-col h-full bg-white rounded-lg border border-gray-200">
    <!-- Chat Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
    <h3 class="text-lg font-semibold text-gray-900">
        Chat
    </h3>
    <div class="flex items-center space-x-2">
        <!-- Semaphore Badge -->
        <app-semaphore-badge
        *ngIf="userSemaphoreColor"
        [color]="userSemaphoreColor"
        [warningCount]="userWarningCount"
        [showText]="false"
        ></app-semaphore-badge>
        
        <!-- Moderation button for organizers -->
        <button
        *ngIf="canModerate && selectedUserToWarn"
        class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200 transition-colors"
        (click)="openModerationModal()"
        >
        âš ï¸ Moderar
        </button>
    </div>
    </div>

    <!-- Messages Area -->
    <div 
    #messagesContainer 
    class="flex-1 overflow-y-auto p-4 space-y-3 min-h-0"
    style="max-height: 400px;"
    >
    <div 
        *ngFor="let message of messages; trackBy: trackByMessageId" 
        class="flex"
        [class.justify-end]="message.sender_id === currentUserId"
    >
        <div 
        class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg break-words cursor-pointer"
        (click)="onMessageClick(message)"
        [class.bg-blue-500]="message.sender_id === currentUserId && !message.is_system"
        [class.text-white]="message.sender_id === currentUserId && !message.is_system"
        [class.bg-gray-200]="message.sender_id !== currentUserId && !message.is_system"
        [class.text-gray-900]="message.sender_id !== currentUserId && !message.is_system"
        [class.bg-yellow-100]="message.is_system"
        [class.text-yellow-800]="message.is_system"
        [class.border]="message.is_system"
        [class.border-yellow-300]="message.is_system"
        >
        <!-- Sender name (only for others' messages and system messages) -->
        <div 
            *ngIf="message.sender_id !== currentUserId || message.is_system" 
            class="text-xs font-semibold mb-1"
            [class.text-gray-600]="!message.is_system"
            [class.text-yellow-700]="message.is_system"
        >
            {{ message.is_system ? 'âš ï¸ Sistema' : getSenderName(message.sender) }}
        </div>
        
        <!-- Message content -->
        <div class="text-sm">{{ message.content }}</div>
        
        <!-- Timestamp -->
        <div 
            class="text-xs mt-1 opacity-75"
            [class.text-gray-300]="message.sender_id === currentUserId && !message.is_system"
            [class.text-gray-500]="message.sender_id !== currentUserId && !message.is_system"
            [class.text-yellow-600]="message.is_system"
        >
            {{ formatTimestamp(message.created_at) }}
        </div>
        </div>
    </div>

    <!-- Loading indicator -->
    <div *ngIf="isLoading" class="text-center py-4">
        <div class="inline-flex items-center space-x-2">
        <div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <span class="text-gray-500">Cargando mensajes...</span>
        </div>
    </div>

    <!-- Empty state -->
    <div *ngIf="messages.length === 0 && !isLoading" class="text-center py-8">
        <div class="text-gray-500">
        <div class="text-4xl mb-2">ğŸ’¬</div>
        <p>No hay mensajes aÃºn</p>
        <p class="text-sm">Â¡SÃ© el primero en escribir algo!</p>
        </div>
    </div>
    </div>

    <!-- Message Input -->
    <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
    <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="flex space-x-2">
        <input
        type="text"
        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Escribe tu mensaje..."
        formControlName="content"
        [disabled]="isBanned || isSending"
        maxlength="500"
        />
        <button
        type="submit"
        class="send-button flex items-center justify-center w-12 h-12 bg-blue-500 text-white rounded-full hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        [disabled]="messageForm.invalid || isBanned || isSending"
        >
            <!-- Paper Plane Icon -->
            <svg 
            class="paper-plane-icon w-5 h-5 transform rotate-45" 
            fill="currentColor" 
            viewBox="0 0 20 20" 
            xmlns="http://www.w3.org/2000/svg"
            >
            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
            </svg>
        </button>
    </form>
    
    <!-- Ban message -->
    <div *ngIf="isBanned" class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded">
        â›” No puedes enviar mensajes porque has sido suspendido de este chat.
    </div>
    </div>
</div>

<!-- Moderation Modal -->
<app-moderation-modal
    [isOpen]="showModerationModal"
    [user]="selectedUserToWarn"
    [contextType]="contextType"
    [contextId]="contextId"
    (close)="closeModerationModal()"
    (warningIssued)="onWarningIssued($event)"
></app-moderation-modal>